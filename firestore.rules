rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ================= HELPERS =================
    // Cek apakah user ada di tenant
    function isUserInTenant(tenantId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/tenants/$(tenantId)/members/$(request.auth.uid));
    }

    // Ambil role user
    function getUserRole(tenantId) {
      return get(/databases/$(database)/documents/tenants/$(tenantId)/members/$(request.auth.uid)).data.role;
    }

    // Cek apakah user termasuk salah satu role di allowedRoles
    function hasRole(tenantId, allowedRoles) {
      return request.auth != null &&
        isUserInTenant(tenantId) &&
        getUserRole(tenantId) in allowedRoles;
    }

    // ================= USERS =================
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // ================= TENANTS =================
    match /tenants/{tenantId} {
      allow create: if request.auth != null &&
        request.resource.data.ownerUid == request.auth.uid &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0;

      allow read: if isUserInTenant(tenantId);
      allow update, delete: if hasRole(tenantId, ['owner','admin']);
    }

    // ================= MEMBERS =================
    match /tenants/{tenantId}/members/{memberId} {
      allow create: if request.auth != null && request.auth.uid == memberId;
      allow read: if isUserInTenant(tenantId);

      // Update/delete: admin bisa, tapi tidak boleh mengubah owner
      allow update, delete: if hasRole(tenantId, ['owner','admin'])
        && !(resource.data.role == 'owner' && !(request.auth.uid == memberId));
    }

    // ================= FOLDER TERBATAS =================
    // Contoh folder yang hanya bisa diakses admin, staff, kordinator
    match /tenants/{tenantId}/folder_terbatas/{document=**} {
      allow read, create, update: if hasRole(tenantId, ['owner','admin','staff','kordinator']);
      allow delete: if hasRole(tenantId, ['owner','admin']);
    }

    // ================= COLLECTIONS =================

    // Barang
    match /tenants/{tenantId}/barang/{docId} {
      allow read: if hasRole(tenantId, ['owner','admin','staff','kordinator','customservice','user','suplayer']);
      allow create, update, delete: if hasRole(tenantId, ['owner','admin','staff']);
    }

    // Pesanan
    match /tenants/{tenantId}/pesanan/{document=**} {
      allow read: if hasRole(tenantId, ['owner','admin','staff','kordinator','customservice','user','suplayer']);
      allow create, update, delete: if hasRole(tenantId, ['owner','admin','staff']);
    }

    // Barang Masuk
    match /tenants/{tenantId}/barang_masuk/{docId} {
      allow read, create, update, delete: if hasRole(tenantId, ['owner','admin','staff']);
    }

    // Barang Keluar
    match /tenants/{tenantId}/barang_keluar/{docId} {
      allow read, create: if hasRole(tenantId, ['owner','admin','staff','kordinator']);
      allow update, delete: if hasRole(tenantId, ['owner','admin','staff']);
    }

    // Menu Kombinasi
    match /tenants/{tenantId}/menu_kombinasi/{docId} {
      allow read: if hasRole(tenantId, ['owner','admin','staff','kordinator','customservice','user']);
      allow create, update: if hasRole(tenantId, ['owner','admin','staff']);
      allow delete: if hasRole(tenantId, ['owner','admin','staff']);
    }

    // Kategori Menu Kombinasi
    match /tenants/{tenantId}/kategori_menu_kombinasi/{docId} {
      allow read: if hasRole(tenantId, ['owner','admin','staff','kordinator','customservice','user']);
      allow create, update: if hasRole(tenantId, ['owner','admin','staff']);
      allow delete: if hasRole(tenantId, ['owner','admin','staff']);
    }

    // ================= DENY ALL OTHER ACCESS =================
    match /{document=**} {
      allow read, write: if false;
    }

  }
}
